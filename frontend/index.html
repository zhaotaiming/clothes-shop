<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬ä¸»ä¹°ä¹°ä¹°</title>
    <style>
        /* å…è®¸æ‰‹æœºç¼©æ”¾æ­£ç¡®å¸ƒå±€ */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0 auto;
            padding: 16px;
            max-width: 900px;
            background: #fafafa;
        }

        /* æ ‡é¢˜å±…ä¸­ï¼Œå¹¶ç¼©å°å­—ä½“é€‚é…æ‰‹æœº */
        h1,
        h2 {
            text-align: center;
            margin: 12px 0;
            font-size: 22px;
        }

        /* å•†å“åˆ—è¡¨ï¼šä¸¤åˆ—å¸ƒå±€ */
        .products {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            justify-content: center;
        }

        /* æ¯ä¸ªå•†å“å¡ç‰‡ */
        .product-card {
            background: #fff;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* å•†å“å›¾ç‰‡ */
        .product-card img {
            width: 100%;
            border-radius: 8px;
            object-fit: cover;
        }

        /* å•†å“æ–‡å­—éƒ¨åˆ† */
        .product-card p {
            margin: 6px 0;
            font-size: 14px;
            width: 100%;
        }

        /* æŒ‰é’®æ ·å¼ */
        .product-card button {
            width: 100%;
            padding: 10px;
            background: #ff6f61;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        /* ğŸ›’è´­ç‰©è½¦ */
        .cart {
            margin-top: 20px;
            background: #fff;
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* è¡¨æ ¼å¯æ»šåŠ¨ï¼Œé¿å…æ‰‹æœºæŒ¤å‹ */
        .cart table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        .cart th,
        .cart td {
            padding: 8px;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        .cart-total {
            text-align: right;
            margin-top: 12px;
            font-weight: bold;
        }

        /* ç”¨æˆ·è¾“å…¥ä¿¡æ¯ */
        .customer-info {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .customer-info input {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        /* æäº¤æŒ‰é’®åŒºåŸŸ */
        .submit-btns {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
        }

        .submit-btns button {
            padding: 10px 18px;
            background: #1AAD19;
            color: white;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* å³ä¸‹è§’æ‚¬æµ®è´­ç‰©è½¦æŒ‰é’® */
        .cart-fab {
            position: fixed;
            right: 16px;
            bottom: 20px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: #ff6f61;
            color: #fff;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            z-index: 1000;
        }

        /* è´­ç‰©è½¦æ•°é‡è§’æ ‡ */
        .cart-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            border-radius: 999px;
            background: #ffef00;
            color: #c00;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æµ®åŠ¨è´­ç‰©è½¦é¢æ¿ */
        .cart-panel {
            position: fixed;
            right: 10px;
            bottom: 80px;
            width: 360px;
            max-height: 70vh;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
            padding: 12px;
            overflow-y: auto;
            z-index: 999;
            display: none;
            /* é»˜è®¤éšè— */
        }

        /* æ‰“å¼€æ—¶çš„çŠ¶æ€ */
        .cart-panel.open {
            display: block;
        }

        /* å•†å“å¸ƒå±€ â€”â€” é»˜è®¤ç”µè„‘ç«¯4åˆ— */
        .products {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            justify-content: center;
        }

        /* å•†å“å¡ç‰‡å®½åº¦è‡ªé€‚åº” */
        .product-card {
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .product-card img {
            width: 100%;
            height: auto;
            border-radius: 6px;
        }


        /* 1200px ä»¥ä¸‹ â†’ 4 åˆ— */
        @media (max-width: 1200px) {
            .products {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* 900px ä»¥ä¸‹ï¼ˆå°å‹ç¬”ç”µ / æ¨ªå± iPadï¼‰â†’ 3 åˆ— */
        @media (max-width: 900px) {
            .products {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* 600px ä»¥ä¸‹ï¼ˆæ‰‹æœºï¼‰â†’ 2 åˆ— */
        @media (max-width: 600px) {
            .products {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>

</head>

<body>
    <div class="page-container">
        <h1>Andmaryæ–°å“ä¸‹å•</h1>

        <h2>å•†å“åˆ—è¡¨</h2>
        <div class="products" id="products"></div>

        <div class="cart" id="cart">
            <!-- å³ä¸‹è§’æ‚¬æµ®è´­ç‰©è½¦æŒ‰é’® -->
            <button id="cart-fab" class="cart-fab" style="display:none;">
                ğŸ›’
                <span id="cart-count" class="cart-badge">0</span>
            </button>

            <!-- æ‚¬æµ®è´­ç‰©è½¦é¢æ¿ -->
            <div id="cart-panel" class="cart-panel">
                <h2>è´­ç‰©è½¦</h2>

                <div id="cart-empty">è´­ç‰©è½¦æ˜¯ç©ºçš„</div>

                <table id="cart-table" style="display:none;">
                    <thead>
                        <tr>
                            <th>å•†å“</th>
                            <th>å•ä»·</th>
                            <th>æ•°é‡</th>
                            <th>å°è®¡</th>
                            <th>æ“ä½œ</th> <!-- æ–°å¢ï¼šåˆ é™¤æŒ‰é’®åˆ— -->
                        </tr>
                    </thead>
                    <tbody id="cart-body"></tbody>
                </table>

                <div class="cart-total" id="cart-total"></div>

                <!-- âœ… åªä¿ç•™å§“å -->
                <div class="customer-info">
                    <label>
                        å§“å
                        <input type="text" id="customer-name" placeholder="è¯·è¾“å…¥æ˜µç§° / ç¾¤å / å§“å" />
                    </label>
                </div>

                <!-- âœ… ä¸€ä¸ªä¸‹å•æŒ‰é’® -->
                <div class="submit-btns">
                    <button onclick="submitOrder()">ä¸‹ å•</button>
                </div>

                <div class="msg" id="message"></div>
            </div>


            <h2 style="margin-top:30px;">ä¸‹å•é¡ºåºï¼ˆå®æ—¶æ›´æ–°ï¼‰</h2>
            <div id="order-rank">åŠ è½½ä¸­...</div>
        </div>

        <script>
            const API_BASE = ''; // åŒä¸€åŸŸåä¸‹ï¼Œç•™ç©ºå³å¯

            let products = [];
            // è´­ç‰©è½¦ç»“æ„ï¼š{ productId, name, price, quantity }
            let cart = [];

            // ==== DOM å¼•ç”¨ ====
            const cartFab = document.getElementById('cart-fab');       // å³ä¸‹è§’æ‚¬æµ®æŒ‰é’®
            const cartPanel = document.getElementById('cart-panel');   // æµ®åŠ¨é¢æ¿
            const cartCountEl = document.getElementById('cart-count'); // å°çº¢ç‚¹æ•°å­—

            const cartEmptyEl = document.getElementById('cart-empty');
            const cartTableEl = document.getElementById('cart-table');
            const cartBodyEl = document.getElementById('cart-body');
            const cartTotalEl = document.getElementById('cart-total');
            const messageEl = document.getElementById('message');

            // ====== åŠ è½½å•†å“ ======
            async function loadProducts() {
                try {
                    const res = await fetch(`${API_BASE}/api/products`);
                    products = await res.json();
                    renderProducts();
                } catch (err) {
                    console.error('åŠ è½½å•†å“å¤±è´¥', err);
                    document.getElementById('products').innerText = 'åŠ è½½å•†å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                }
            }

            function renderProducts() {
                const container = document.getElementById('products');
                container.innerHTML = '';

                products.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                <img src="${p.image}" alt="${p.name}">
                <div>${p.name}</div>
                <div>ï¿¥${p.price}</div>
                <small>${p.description || ''}</small>
            `;

                    const btn = document.createElement('button');
                    btn.innerText = 'åŠ å…¥è´­ç‰©è½¦';
                    btn.onclick = () => addToCart(p);  // ç‚¹å‡»æ—¶æŠŠæ•´ä»¶å•†å“ä¼ è¿›è´­ç‰©è½¦
                    card.appendChild(btn);

                    container.appendChild(card);
                });
            }

            // ====== è´­ç‰©è½¦ç›¸å…³ ======

            // æ‚¬æµ®æŒ‰é’®ï¼šå±•å¼€/æ”¶èµ·è´­ç‰©è½¦é¢æ¿
            if (cartFab) {
                cartFab.addEventListener('click', () => {
                    cartPanel.classList.toggle('open');
                });
            }

            // åŠ å…¥è´­ç‰©è½¦
            function addToCart(product) {
                const existing = cart.find(item => item.productId === product.id);
                if (existing) {
                    existing.quantity += 1;
                } else {
                    cart.push({
                        productId: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: 1
                    });
                }
                renderCart();
            }

            // ä»è´­ç‰©è½¦åˆ é™¤æŸä¸€é¡¹
            function removeFromCart(index) {
                cart.splice(index, 1);
                renderCart();
            }

            // æ¸²æŸ“è´­ç‰©è½¦ï¼ˆè¡¨æ ¼ + åˆè®¡ + æ‚¬æµ®æŒ‰é’®è§’æ ‡ï¼‰
            function renderCart() {
                if (!cartEmptyEl || !cartTableEl || !cartBodyEl || !cartTotalEl) return;

                if (cart.length === 0) {
                    // ç©ºè´­ç‰©è½¦
                    cartEmptyEl.style.display = 'block';
                    cartTableEl.style.display = 'none';
                    cartBodyEl.innerHTML = '';
                    cartTotalEl.innerText = '';

                    // éšè—æ‚¬æµ®æŒ‰é’® & è§’æ ‡æ¸…é›¶ & æ”¶èµ·é¢æ¿

                    if (cartPanel) {
                        cartPanel.classList.remove('open');
                    }
                    return;
                }

                // æœ‰å•†å“ï¼šæ˜¾ç¤ºè¡¨æ ¼
                cartEmptyEl.style.display = 'none';
                cartTableEl.style.display = 'table';

                let total = 0;
                cartBodyEl.innerHTML = '';

                cart.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    const subTotal = item.price * item.quantity;
                    total += subTotal;

                    tr.innerHTML = `
                <td>${item.name}</td>
                <td>ï¿¥${item.price}</td>
                <td>${item.quantity}</td>
                <td>ï¿¥${subTotal}</td>
                <td>
                    <button onclick="removeFromCart(${index})">åˆ é™¤</button>
                </td>
            `;
                    cartBodyEl.appendChild(tr);
                });

                cartTotalEl.innerText = `åˆè®¡ï¼šï¿¥${total}`;

                // æ›´æ–°æ‚¬æµ®æŒ‰é’® & è§’æ ‡
                const count = cart.reduce((sum, item) => sum + item.quantity, 0);
                if (cartCountEl) {
                    cartCountEl.textContent = count;
                }
                if (cartFab) {
                    cartFab.style.display = 'flex'; // æœ‰å•†å“å°±æ˜¾ç¤ºæŒ‰é’®
                }
            }

            // ====== æäº¤è®¢å• ======
            async function submitOrder() {
                messageEl.style.color = '#e66';
                messageEl.innerText = '';

                if (cart.length === 0) {
                    messageEl.innerText = 'è´­ç‰©è½¦æ˜¯ç©ºçš„';
                    return;
                }

                const name = document.getElementById('customer-name').value.trim();
                if (!name) {
                    messageEl.innerText = 'è¯·å¡«å†™å§“åï¼ˆå¯ä»¥å†™æ˜µç§°ï¼‰';
                    return;
                }

                const payload = {
                    items: cart,
                    customer: {
                        name: name
                    }
                };

                try {
                    const res = await fetch(`${API_BASE}/api/orders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    if (!res.ok) {
                        messageEl.innerText = data.message || 'æäº¤è®¢å•å¤±è´¥';
                        return;
                    }

                    messageEl.style.color = '#1AAD19';
                    messageEl.innerText = `ä¸‹å•æˆåŠŸï¼ï¼ˆè®¢å•å·ï¼š${data.orderId}ï¼‰ã€‚`;

                    // æ¸…ç©ºè´­ç‰©è½¦ & è¾“å…¥æ¡†
                    cart = [];
                    renderCart();
                    document.getElementById('customer-name').value = '';
                } catch (err) {
                    console.error('æäº¤è®¢å•å¤±è´¥', err);
                    messageEl.innerText = 'æœåŠ¡å™¨é”™è¯¯ï¼Œç¨åå†è¯•';
                }
            }

            // ====== å…¬å…±ä¸‹å•é¡ºåºåˆ—è¡¨ ======
            async function loadOrderRank() {
                try {
                    const res = await fetch('/api/public-orders');
                    const data = await res.json();

                    const box = document.getElementById('order-rank');

                    if (!data.length) {
                        box.innerHTML = "è¿˜æ²¡æœ‰äººä¸‹å•~ ğŸ§¸";
                        return;
                    }

                    let html = "<ul style='list-style:none;padding:0;font-size:15px;'>";

                    data.forEach(o => {
                        const itemsText = o.items.join(" | ");

                        html += `
                    <li style="margin:10px 0;padding:8px;background:#fff;border-radius:6px;">
                        <div><strong>#${o.id}</strong>  ${o.name}</div>
                        <div style="color:#444;font-size:14px;margin-top:4px;">
                            ğŸ› ${itemsText}
                        </div>
                        <div style="color:gray;font-size:12px;margin-top:3px;">
                            ${new Date(o.createdAt).toLocaleString()}
                        </div>
                    </li>
                `;
                    });

                    html += "</ul>";
                    box.innerHTML = html;

                } catch (e) {
                    document.getElementById('order-rank').innerHTML = "åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°";
                }
            }

            // ====== åˆå§‹åŒ– ======
            loadProducts();
            loadOrderRank();
            setInterval(loadOrderRank, 60000);
        </script>


</body>

</html>